<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Format Converter - QuickTools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="/static/index.html" class="logo">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                        <rect width="32" height="32" rx="8" fill="url(#gradient)"/>
                        <path d="M16 8L24 16L16 24L8 16L16 8Z" fill="white"/>
                        <defs>
                            <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32">
                                <stop offset="0%" stop-color="#3B82F6"/>
                                <stop offset="100%" stop-color="#8B5CF6"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <span>QuickTools</span>
                </a>
                
                <div class="nav-links">
                    <a href="/static/index.html#tools" class="nav-link">Tools</a>
                    <a href="/static/index.html#pricing" class="nav-link">Pricing</a>
                    <a href="/static/support.html" class="nav-link">Support</a>
                    <a href="/static/api-keys.html" class="nav-link" id="apiKeysNav" style="display: none;">API</a>
                </div>
                
                <div class="nav-actions">
                    <div id="authButtons">
                        <a href="/static/index.html" class="btn btn-text">Back to Home</a>
                    </div>
                    <div id="userButtons" style="display: none;">
                        <div class="user-menu">
                            <span class="user-email" id="userEmail"></span>
                            <span class="user-credits" id="userCredits">0 credits</span>
                            <button class="btn btn-text" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container" style="max-width: 800px; padding-top: var(--space-12); padding-bottom: var(--space-12);">
            
            <h2 class="workspace-title" style="margin-bottom: var(--space-8);">Image Format Converter</h2>
            
            <div class="message" id="messageBox" style="display: none;"></div>
            
            <!-- Upload Section -->
            <div class="tool-workspace" id="uploadSection">
                <form id="convertForm">
                    <div class="upload-area" id="uploadArea">
                        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                        </svg>
                        <h3>Drop image here</h3>
                        <p>or click to browse (JPG, PNG, WebP, BMP, TIFF - max 20MB)</p>
                        <input type="file" id="fileInput" accept="image/*" hidden required>
                    </div>

                    <div class="form-section" id="formatSection" style="display: none; margin-top: var(--space-6);">
                        <label class="form-label">Convert to:</label>
                        <div class="format-buttons" style="display: flex; gap: var(--space-3); flex-wrap: wrap;">
                            <button type="button" class="format-btn" data-format="png">PNG</button>
                            <button type="button" class="format-btn" data-format="jpg">JPG</button>
                            <button type="button" class="format-btn" data-format="webp">WebP</button>
                            <button type="button" class="format-btn" data-format="bmp">BMP</button>
                            <button type="button" class="format-btn" data-format="tiff">TIFF</button>
                        </div>

                        <div id="qualitySection" style="margin-top: var(--space-4); display: none;">
                            <label class="form-label">Quality: <span id="qualityValue">100</span>%</label>
                            <input type="range" id="qualitySlider" min="1" max="100" value="100" style="width: 100%;">
                            <p style="font-size: var(--text-sm); color: var(--gray-600); margin-top: var(--space-2);">
                                100% = Maximum quality (larger file). 85-95% = Good balance. JPG/WebP only.
                            </p>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large w-full" id="convertBtn" disabled style="margin-top: var(--space-6);">
                        Convert Image (1 credit)
                    </button>
                </form>
            </div>

            <!-- Processing -->
            <div id="processingSection" style="display: none; text-align: center; padding: var(--space-12) 0;">
                <div class="spinner"></div>
                <p style="margin-top: var(--space-4); color: var(--gray-600);">Converting image...</p>
            </div>

            <!-- Results -->
            <div id="resultsSection" class="tool-workspace" style="display: none; margin-top: var(--space-8);">
                <h3 style="font-size: var(--text-xl); font-weight: 700; margin-bottom: var(--space-4);">âœ… Conversion Complete!</h3>
                
                <div class="result-card" style="background: var(--gray-50); padding: var(--space-4); border-radius: var(--radius-lg); margin-bottom: var(--space-4);">
                    <div style="display: grid; gap: var(--space-3);">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray-600);">Original format:</span>
                            <strong id="originalFormat">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray-600);">New format:</span>
                            <strong id="newFormat">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray-600);">Original size:</span>
                            <strong id="originalSize">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray-600);">New size:</span>
                            <strong id="newSize">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray-600);">Size change:</span>
                            <strong id="sizeChange">-</strong>
                        </div>
                    </div>
                </div>

                <a id="downloadLink" class="btn btn-primary btn-large w-full" style="margin-bottom: var(--space-3);">
                    ðŸ’¾ Download Converted Image
                </a>
                <button class="btn btn-secondary btn-large w-full" onclick="resetForm()">
                    Convert Another Image
                </button>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let selectedFile = null;
        let selectedFormat = null;
        let currentUser = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        // Drag & drop
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary)';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--gray-300)';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--gray-300)';
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/bmp', 'image/tiff'];
            if (!validTypes.includes(file.type)) {
                showMessage('Invalid file type. Please upload an image.', 'error');
                return;
            }

            if (file.size > 20 * 1024 * 1024) {
                showMessage('File too large. Maximum size is 20MB.', 'error');
                return;
            }

            selectedFile = file;
            document.getElementById('formatSection').style.display = 'block';
            
            uploadArea.querySelector('h3').textContent = file.name;
            uploadArea.querySelector('p').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB - Select output format below`;
        }

        // Format buttons
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedFormat = btn.dataset.format;
                
                // Show quality slider for lossy formats
                const qualitySection = document.getElementById('qualitySection');
                if (['jpg', 'webp'].includes(selectedFormat)) {
                    qualitySection.style.display = 'block';
                } else {
                    qualitySection.style.display = 'none';
                }
                
                document.getElementById('convertBtn').disabled = false;
            });
        });

        // Quality slider
        document.getElementById('qualitySlider').addEventListener('input', (e) => {
            document.getElementById('qualityValue').textContent = e.target.value;
        });

        // Form submit
        document.getElementById('convertForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedFile || !selectedFormat) return;

            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('Please sign in to use this tool', 'error');
                window.location.href = '/static/index.html';
                return;
            }

            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('to_format', selectedFormat);
            formData.append('quality', document.getElementById('qualitySlider').value);

            try {
                const response = await fetch(`${API_BASE}/api/convert/format`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update results
                    document.getElementById('originalFormat').textContent = result.original_format.toUpperCase();
                    document.getElementById('newFormat').textContent = result.output_format.toUpperCase();
                    document.getElementById('originalSize').textContent = `${(result.original_size / 1024 / 1024).toFixed(2)} MB`;
                    document.getElementById('newSize').textContent = `${(result.output_size / 1024 / 1024).toFixed(2)} MB`;
                    
                    const changeText = result.size_change_percent > 0 
                        ? `+${result.size_change_percent}% larger`
                        : `${Math.abs(result.size_change_percent)}% smaller`;
                    document.getElementById('sizeChange').textContent = changeText;
                    document.getElementById('sizeChange').style.color = result.size_change_percent > 0 ? 'var(--error)' : 'var(--success)';
                    
                    document.getElementById('downloadLink').href = result.download_url;
                    document.getElementById('downloadLink').download = true;
                    
                    // Update credits
                    if (result.credits_remaining !== undefined) {
                        document.getElementById('userCredits').textContent = `${result.credits_remaining} credits`;
                    }
                    
                    document.getElementById('processingSection').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                    
                    showMessage('Image converted successfully!', 'success');
                    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(result.detail || 'Conversion failed');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
                document.getElementById('processingSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
            }
        });

        function resetForm() {
            selectedFile = null;
            selectedFormat = null;
            document.getElementById('convertForm').reset();
            document.getElementById('formatSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('convertBtn').disabled = true;
            document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
            uploadArea.querySelector('h3').textContent = 'Drop image here';
            uploadArea.querySelector('p').textContent = 'or click to browse (JPG, PNG, WebP, BMP, TIFF - max 20MB)';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showMessage(text, type) {
            const box = document.getElementById('messageBox');
            box.textContent = text;
            box.className = `message message-${type}`;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 5000);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/index.html';
        }

        // Initialize
        async function init() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/static/index.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Auth failed');

                currentUser = await response.json();

                document.getElementById('authButtons').style.display = 'none';
                document.getElementById('userButtons').style.display = 'flex';
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userCredits').textContent = `${currentUser.credits_balance} credits`;

                if (currentUser.api_access_unlocked) {
                    document.getElementById('apiKeysNav').style.display = 'block';
                }
            } catch (error) {
                console.error('Init error:', error);
                localStorage.removeItem('token');
                window.location.href = '/static/index.html';
            }
        }

        init();
    </script>
</body>
</html>
